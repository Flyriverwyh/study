
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [CNM模型](#cnm模型)
- [CNI模型](#cni模型)
  - [CNI规范概述](#cni规范概述)

<!-- /code_chunk_output -->

随着容器技术在企业生产系统中的逐步落地，用户对容器云的网络特性要求也越来越高。

**跨主机！！！容器间！！！的网络互通**已经成为基本要求，更高的要求包括**容器固定IP地址**、**一个容器多个IP地址**、**多个子网隔离**、**ACL控制策略**、**与SDN集成**等。

目前主流的**容器网络模型**主要有**Docker公司**提出的**Container Network Model（CNM）模型**和**CoreOS**公司提出的**Container Network Interface（CNI）模型**。

# CNM模型

CNM模型是由Docker公司提出的容器网络模型，现在已经被Cisco Contiv、Kuryr、Open Virtual Networking（OVN）、Project Calico、VMware、Weave和Plumgrid等项目所采纳。

另外，Weave、Project Calico、Kuryr和Plumgrid等项目也为CNM提供了**网络插件的具体实现**。

CNM模型主要通过**Network Sandbox**、**Endpoint**和**Network**这3个组件进行实现，如图7.17所示。

![2019-09-22-19-20-59.png](./images/2019-09-22-19-20-59.png)

# CNI模型

CNI是由CoreOS公司提出的另一种容器网络规范，现在已经被Kubernetes、rkt、Apache Mesos、Cloud Foundry和Kurma等项目采纳。

另外，Contiv Networking, Project Calico、Weave、SR-IOV、Cilium、Infoblox、Multus、Romana、Plumgrid和Midokura等项目也为CNI提供网络插件的具体实现。

图7.18描述了**容器运行环境**与**各种网络插件**通过CNI进行连接的模型。

![2019-09-22-19-23-21.png](./images/2019-09-22-19-23-21.png)

**CNI**定义的是**容器运行环境**与**网络插件**之间的**简单接口规范**，通过一个**JSON Schema**定义**CNI插件**提供的**输入**和**输出参数**。**一个容器**可以通过**绑定多个网络插件**加入**多个网络**中。

本节将对Kubernetes如何实现CNI模型进行详细说明。

## CNI规范概述

CNI提供了一种**应用容器的插件化网络**解决方案，定义对容器网络进行操作和配置的规范，通过**插件的形式！！！** 对**CNI接口**进行**实现**。

CNI是由**rkt Networking Proposal**发展而来的，试图提供一种普适的容器网络解决方案。

CNI**仅关注**在**创建容器**时**分配网络资源**，和在**销毁容器**时**删除网络资源**，这使得CNI规范非常轻巧、易于实现，得到了广泛的支持。

在CNI模型中**只涉及两个概念**：**容器**和**网络**。

* 容器（Container）：是拥有**独立Linux网络命名空间**的环境，例如使用Docker或rkt创建的容器。关键之处是**容器需要拥有自己的Linux网络命名空间**，这是加入网络的必要条件。
* 网络（Network）：表示可以互连的一组实体，这些实体拥有各自独立、唯一的IP地址，可以是容器、物理机或者其他网络设备（比如路由器）等。

对容器网络的设置和操作都通过插件（Plugin）进行具体实现，CNI插件包括两种类型：CNI Plugin和IPAM（IP Address Management）Plugin。CNI Plugin负责为容器配置网络资源，IPAM Plugin负责对容器的IP地址进行分配和管理。IPAM Plugin作为CNI Plugin的一部分，与CNI Plugin一起工作。

2.CNI Plugin插件详解

CNI Plugin包括3个基本接口的定义：添加（ADD）、删除（DELETE）、检查（CHECK）和版本查询（VERSION）。这些接口的具体实现要求插件提供一个可执行的程序，在容器网络添加或删除时进行调用，以完成具体的操作。

（1）添加：将容器添加到某个网络。主要过程为在Container Runtime创建容器时，先创建好容器内的网络命名空间（Network Namespace），然后调用CNI插件为该netns进行网络配置，最后启动容器内的进程。

添加接口的参数如下。

* Version：CNI版本号。
* Container ID：容器ID。
* Network namespace path：容器的网络命名空间路径，例如/proc/[pid]/ns/net。
* Network configuration：网络配置JSON文档，用于描述容器待加入的网络。
* Extra arguments：其他参数，提供基于容器的CNI插件简单配置机制。
* Name of the interface inside the container：容器内的网卡名。

返回的信息如下。

* Interfaces list：网卡列表，根据Plugin的实现，可能包括Sandbox Interface名称、主机Interface名称、每个Interface的地址等信息。
* IPs assigned to the interface：IPv4或者IPv6地址、网关地址、路由信息等。
* DNS information：DNS相关的信息。
（2）删除：容器销毁时将容器从某个网络中删除。
删除接口的参数如下。
* Version：CNI版本号。
* Container ID：容器ID。
* Network namespace path：容器的网络命名空间路径，例如/proc/[pid]/ns/net。
* Network configuration：网络配置JSON文档，用于描述容器待加入的网络。
* Extra arguments：其他参数，提供基于容器的CNI插件简单配置机制。
* Name of the interface inside the container：容器内的网卡名。

（3）检查：检查容器网络是否正确设置。

检查接口的参数如下。

* Container ID：容器ID。
* Network namespace path：容器的网络命名空间路径，例如/proc/[pid]/ns/net。
* Network configuration：网络配置JSON文档，用于描述容器待加入的网络。
* Extra arguments：其他参数，提供基于容器的CNI插件简单配置机制。
* Name of the interface inside the container：容器内的网卡名。

（4）版本查询：查询网络插件支持的CNI规范版本号。
