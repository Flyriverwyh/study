
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1. 概述](#1-概述)
  - [1.1. 背景需求](#11-背景需求)
  - [1.2. API机制](#12-api机制)
  - [1.3. 两种API扩展机制](#13-两种api扩展机制)
- [2. 使用CRD扩展API资源](#2-使用crd扩展api资源)

<!-- /code_chunk_output -->

# 1. 概述

## 1.1. 背景需求

随着Kubernetes的发展，用户对Kubernetes的扩展性也提出了越来越高的要求。

从**1.7版本**开始，Kubernetes引入**扩展API资源的能力**，使得开发人员在**不修改Kubernetes核心代码**的前提下可以**对Kubernetes API进行扩展**，仍然使用Kubernetes的语法对**新增的API**进行操作，这非常适用于在Kubernetes上通过其API实现**其他功能**（例如**第三方性能指标采集服务**）或者**测试实验性新特性**（例如**外部设备驱动**）。

## 1.2. API机制

* 资源对象的抽象和访问入口: 在Kubernetes中，**所有对象**都被抽象定义为**某种资源对象**，同时系统会为其设置一个**API入口（API Endpoint**），**对资源对象的操作**（如新增、删除、修改、查看等）都需要通过**Master**的**核心组件API Server调用资源对象的API**来完成。

* 交互方式: **与API Server的交互**可以通过**kubectl命令行工具**或**访问其RESTful API**进行。

* API的不同版本: **每个API**都可以设置**多个版本**，在**不同的API URL路径**下区分，例如“/api/v1”或“/apis/extensions/v1beta1”等。

使用这种机制后，用户可以很方便地**定义这些API资源对象（YAML配置**），并将其**提交给Kubernetes（调用RESTful API**），来完成对容器应用的各种管理工作。

## 1.3. 两种API扩展机制

Kubernetes系统内置的Pod、RC、Service、ConfigMap、Volume等资源对象已经能够满足常见的容器应用管理要求，但如果用户希望将其自行开发的第三方系统纳入Kubernetes，并使用Kubernetes的API对其自定义的功能或配置进行管理，就需要对API进行扩展了。

目前Kubernetes提供了以下两种机制供用户扩展API。

（1）**使用CRD机制**：**复用Kubernetes的API Server**，**无须编写额外的API Server**。用户**只需要定义CRD**，并且提供一个**CRD控制器**，就能通过Kubernetes的API管理自定义资源对象了，同时要求**用户的CRD对象符合API Server的管理规范**。

（2）使用**API聚合机制**：用户需要**编写额外的API Server**，可以对资源进行**更细粒度的控制**（例如，如何在各API版本之间切换），要求用户自行处理对多个API版本的支持。

本节主要对CRD和API聚合这两种API扩展机制的概念和用法进行详细说明。

# 2. 使用CRD扩展API资源

CRD是Kubernetes从**1.7版本**开始引入的特性，在Kubernetes**早期版本**中被称为**TPR**（**ThirdPartyResources**，第三方资源）。TPR从Kubernetes 1.8版本开始被停用，被CRD全面替换。

CRD本身**只是一段声明**，用于**定义用户自定义的资源对象**。但**仅有CRD的定义**并没有实际作用，用户还需要提供**管理CRD对象的CRD控制器**（CRD Controller），才能实现**对CRD对象的管理**。

**CRD控制器**通常可以通过Go语言进行开发，并需要遵循Kubernetes的控制器开发规范，基于客户端库client-go进行开发，需要实现Informer、ResourceEventHandler、Workqueue等组件具体的功能处理逻辑，详细的开发过程请参考官方示例（https://github.com/kubernetes/sample-controller）和client-go库（https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md）的详细说明。

1.创建CRD的定义

与其他资源对象一样，对CRD的定义也使用YAML配置进行声明。以Istio系统中的自定义资源VirtualService为例，配置文件crd-virtualservice.yaml的内容如下：

