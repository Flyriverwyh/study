参考：

http://blog.csdn.net/vito_bin/article/details/60779404

## 基本概念

MMIO(Memory mapping I/O)，即内存映射I/O，它是PCI规范的一部分，I/O设备被放置在内存空间而不是I/O空间。从处理器的角度看，内存映射I/O后系统设备访问起来和内存一样。这样访问AGP/PCI-E显卡上的**帧缓存**，BIOS，PCI设备就可以使用读写内存一样的汇编指令完成，简化了程序设计的难度和接口的复杂性。

I/O作为CPU和外设交流的一个渠道，主要分为两种，一种是Port I/O，一种是MMIO(Memory mapping I/O)。

Port I/O就是我们常说的I/O端口，它实际上的应该被称为I/O地址空间。

对于x86架构来说，I/O地址空间通过IN/OUT指令访问（不是MMIO访问方式）。PC架构一共有65536个8bit的I/O端口，组成64K I/O地址空间，编号从0~0xFFFF。连续两个8bit的端口可以组成一个16bit的端口，连续4个组成一个32bit的端口。I/O地址空间和CPU的物理地址空间是两个不同的概念，例如I/O地址空间为64K，一个32bit的CPU物理地址空间是4G。

MMIO占用CPU的物理地址空间，对它的访问可以使用CPU访问内存的指令进行。一个形象的比喻是把文件用mmap()后，可以像访问内存一样访问文件、同样，MMIO是用访问内存一样的方式访问I/O资源，如设备上的内存。MMIO不能被cache（有特殊情况，如VGA）。

32位操作系统，32bit的处理器，拥有32bit寻址能力，即可访问2^32=4G的物理地址，那么就具有4G内存的识别能力。

物理地址：并不是指物理内存的地址，而是指处理器和系统内存之间所用到的地址，可以理解为CPU最为方便访问的地址（有别于我们之前所知道的物理地址的定义：段地址*16+偏移地址\<8086\>），而这一个内存并不独属于物理内存，而被分成了很多部分，物理内存当然也能够占用其中的一部分。

地址范围：0x0000 0000   -------->0xFFFF FFFF

我们所提到的4G物理地址和所安装的内存条没有任何关系，是相互独立的。

即使安装的是2G内存，但计算机依然会分配4G的内存空间。

## Port I/O和MMIO主要区别

- 前者不占用CPU的物理地址空间，后者占有（这是对x86架构说的，一些架构，如IA64，port I/O占用物理地址空间）。

- 前者是顺序访问。也就是说在一条I/O指令完成前，下一条指令不会执行。例如通过Port I/O对设备发起了操作，造成了设备寄存器状态变化，这个变化在下一条指令执行前生效。uncache的MMIO通过uncahce memory的特性保证顺序性。

- 使用方式不同

由于port I/O有独立的64K I/O地址空间，但CPU的地址线只有一套，所以必须区分地址属于物理地址空间还是I/O地址空间。

## 映射地址空间

目前，大多数的CPU都支持36bit寻址，也就是说寻址范围达到了64G，但这只是从“系统”的视角来说，从“内存控制器”的视角来说，由于32bit的寻址能力的限制，只能访问4G空间。如果需要计算机正常工作，则所有必须的设备地址都需要存在这4G的空间当中，使计算机正常工作除了内存之外，也包括许多IO设备。图中展示了4Gb地址的大致分布，除去main memory之外，大多数都只占据极少的内存，一般为几M或者几十M，除了PCI ECAM。（PCI Memory range）

![config](images/1.png)

