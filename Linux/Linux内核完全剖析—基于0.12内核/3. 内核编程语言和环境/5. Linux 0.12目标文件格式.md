- 3.5　Linux 0.12目标文件格式

    - 3.5.1　目标文件格式

    - 3.5.2　Linux0.12中的目标文件格式
    
    - 3.5.3　链接程序输出
    
    - 3.5.4　链接程序预定义变量一

    - 3.5.5　System.map文件

Linux0.12内核使用了两种编译器。

- 第一种是汇编编译器as86和相应的链接程序（或称链接器）ld86。用于编译和链接运行在实地址模式下的16位内核引导扇区程序bootsect.S 和设置程序setup.s。

- 第二种是GNU的汇编器as（gas）和C语言编译器gcc以及相应的链接程序gld。编译器用于为源程序文件产生对应的二进制代码和数据目标文件。链接程序用于对相关的所有目标文件进行组合处理，形成一个可被内核加载执行的目标文件，即可执行文件。
 
首先说明编译器产生的目标文件结构，然后描述链接器如何把需要链接在一起的目标文件模块组合在一起，以生成二进制可执行映像文件或一个大的模块文件。最后说明Linux0.12内核二进制代码文件Image的生成原理和过程。这里给出的是Linux 0.12内核支持的a.out目标文件格式的信息。as86和ld86生成的是MINIX专门的目标文件格式，后续给出。有关目标文件和链接程序的基本工作原理可参考“Linkers & Loaders”书。

这里把编译器生成的目标文件称为目标模块文件（简称模块文件），链接程序输出的称为可执行文件。将它们统一称为目标文件。

## 1. 目标文件格式

Linux 0.12中，GNU gcc或gas输出的目标模块文件和可执行文件都使用了UNIX传统的a.out格式。这是一种被称为汇编与链接输出（Assembly & linker editor output）的目标文件格式。对于有内存分页机制的OS来说，这是一种简单有效的目标文件格式。a.out格式文件由一个文件头和随后的代码区（text section，也称为正文段）、已初始化数据区（data section，也称为数据段）、重定位信息区符号表以及符号名字符串构成，如图3-7.其中代码区和数据区通常也被分别称为正文段（代码段）和数据段。

![3-7 a.out格式的目标文件](images/3.png)

- 执行头（exec header）。包含参数信息（exec 结构），是有关目标文件的整体结构信息。例如代码和数据区长度、未初始化数据区的长度、对应源程序文件名以及目标文件创建时间等。内核使用这些参数将可执行文件加载到内存中并执行，而链接程序（ld）使用这些参数将一些模块文件组成一个可执行文件。这是目标文件唯一必要的组成部分。

- 代码区（text segment）。含有程序执行时被加载到内存中的指令代码和相关数据。只读形式加载。 

- 数据区（data segment）。含有已经初始化过的数据，总是被加载到可读写内存中。 

- 代码重定位部分（text relocation）。含有供链接程序使用的记录数据。在组合目标模块文件时用于定位代码段中的指针或地址。当链接程序需要改变目标代码的地址时就需要修正和维护这些地方。

- 数据重定位部分（data relocation）。类似上面，但用于数据段中指针的重定位。

- 符号表部分（symbol table）。含有供链接程序使用的记录数据。这些数据保存着模块文件中定义的全局符号以及需要从其他模块文件中输入的符号，或由链接器定义的符号，用于在模块文件之间对命名的变量和函数（符号）进行交叉引用。

- 字符串表部分（string table）。含有与符号名相对应的字符串，供调试程序调试目标代码，与链接程序无关。

由于Linux 0.12使用了Intel CPU的内存管理功能，因此它会为每个执行程序单独分配一个64MB的地址空间（逻辑地址空间）使用。在这种情况下，因为链接器已经把执行文件处理成从一个固定地址开始运行，所以相关的可执行文件中就不再需要重定位信息。

### 1.1 执行头部分

### 1.2 

## 2. Linux0.12中的目标文件格式

## 3. 链接程序输出

## 4. 链接程序预定义变量一

## 5. System.map文件