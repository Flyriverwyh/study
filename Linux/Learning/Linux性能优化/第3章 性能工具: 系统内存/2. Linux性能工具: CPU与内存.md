
# vmstat（II）

如前所见，vmstat能提供多个不同方面的系统性能信息——尽管它的主要目的（如同下面展示的一样）是提供虚拟内存系统信息。除了前一章描述的CPU性能统计信息外，它还可以告诉你下述信息：

* 使用了多少交换分区。
* 物理内存是如何被使用的。
* 有多少空闲内存。

你可以看到，vmstat（通过其显示的统计数据）在一行文本中就提供了关于系统运行状况与性能的丰富信息。

## 系统范围内与内存相关的系统级选项

vmstat除了提供CPU统计信息外，你还可以通过如下命令行调用vmstat来调查内存统计信息：
￼
```
vmstat [-a] [-s] [-m]
```

和前面一样，你可以在两种模式下运行vmstat：采样模式和平均模式。添加命令行选项能让你获得Linux内核使用内存的性能统计信息。表3-1给出了vmstat可接受的选项。

表3-1 vmstat命令行选项

![2019-12-08-15-26-00.png](./images/2019-12-08-15-26-00.png)
￼
表3-2所示列表为vmstat可以提供的内存统计信息。与CPU统计信息一样，当运行于普通模式时，vmstat提供的第一行信息为所有速率统计信息（so和si）的均值以及所有数字统计信息的瞬时值（swpd、free、buff、cache、active和inactive）。

表3-2 与内存相关的vmstat输出统计信息:

![2019-12-08-15-28-01.png](./images/2019-12-08-15-28-01.png)
￼
对给定机器而言，vmstat能提供其虚拟存储系统当前状态的良好概览。虽然它不会为每个可用的Linux每次性能统计数据提供一个完整且详细的列表，但它给出的简洁输出可以表明系统内存整体上是如何被使用的。

## 用法示例

如前面章节所见，清单3.2中，如果vmstat调用时没有使用任何命令行选项，它显示的是从系统启动开始的性能统计数据的均值（si和so），以及其他统计信息的瞬时值（swpd、free、buff和cache）。本例中，我们可以看到系统已经有大约500MB的内存交换到了硬盘。约14MB系统内存是空闲的。约4MB用于缓冲区，以保存还未刷新到硬盘的数据。约627MB用于硬盘缓存，以保存过去从硬盘读取的数据。
清单3.2
￼
在清单3.3中，我们要求vmstat显示活跃与非活跃页面的数量信息。非活跃页面的数量表明了有多少内存可以交换到硬盘，有多少内存是当前可用的。本例中，我们可以看到活跃内存有1310MB，只有78MB被认为是不活跃的。该机拥有大量内存，且大部分都被使用，处于活跃状态。
清单3.3
￼
接下来，在清单3.4中，我们看到的是一个不同的系统，其内存数据交换频繁。si列显示在每个采样期间，数据的读交换率分别为480KB、832KB、764KB、344KB和512KB。so列显示在每个采样期间，内存数据写交换率分别为9KB、0KB、916KB、0KB、1068KB、444KB和792KB。这些结果可以说明该系统没有足够的内存来处理所有的运行进程。当一个进程的内存被保存下来，以便为之前已经交换到硬盘的应用程序腾位置时，就会出现高频率的换入和换出。如果有两个运行程序需要的内存量都超过了系统可提供的量，后果就会很糟糕。比如，两个进程都在使用大量内存，且它们都试图同时运行，而每个进程都可以导致另一个的内存被写交换。当一个程序需要一块内存时，它就会把另一个程序需要的一块内存踢出去。而当另一个应用程序开始运行时，它又会把第一个程序正在使用的一块内存踢出去，并等待自己的内存块从交换分区加载进来。这可能会导致两个应用程序出现停顿，以等待它们的内存从交换分区取回，然后才能继续执行。只要一个程序进步一点点，它就会将另一个进程使用的内存交换出去，从而导致这个程序慢下来。这种情况被称为颠簸。发生颠簸时，系统会花大量的时间将内存读出或写入交换分区，系统性能就会急剧下降。
