- 4.8 保护模式编程初始化
    - 4.8.1 进入保护模式时的初始化操作
    - 4.8.2 模式切换

80X86可以工作在几种模式下。当机器上电或硬件复位时，处理器工作实地址模式下，并且从物理地址 OxFFFFFFF0处开始执行软件初始化代码（通常在 EPROM中）。软件初始化代码首先必须设置基本系统功能操作必要的数据结构信息，例如处理中断和异常的实模式 IDT表（即中断向量表）。如果处理器将仍然工作在实模式下，那么软件必须加载操作系统模块和相应数据以允许应用程序能在实模式下可靠地运行。如果处理器将要工作在保护模式下，那么操作系统软件就必须加载保护模式操作必要的数据结构信息，然后切换到保护模式。

## 1. 进入保护模式时的初始化操作

保护模式所需要的一些数据结构由处理器内存管理功能确定。处理器支持分段模型可以使用从单个、统一的地址空间平坦模型到每个任务都具有几个受保护地址空间的高度结构化的多段模型。分页机制能够用来部分在内存、部分在磁盘上的大型数据结构信息。这两种地址转换形式都需要操作系统在内存中为内存管理硬件设置所要求的数据结构。因此在处理器能够被切换到保护模式下运行之前，操作系统加载和初始化软件(bootsect.s、 setups和 heads)必须在内存中先设置好保护模式下使用的数据结构的基本信息。这些数据结构包括以下几种：

- 保护模式中断描述符表 IDT;
- 全局描述符表 GDT;
- 任务状态段 TSS;
- 局部描述符表 LDT;
- 若使用分页机制，则起码需要设置一个页目录和一个東表；
- 处理器切换到保护模式下运行的代码段；
- 含有中断和异常处理程序的代码模块。

在能够切换到保护模式之前，软件初始化代码还必须设置以下系统寄存器；

- 全局描述符表基地址寄存器 GDTR；
- 中断描述符表基地址寄存器 IDTR;
- 控制寄存器 CRI--CR3;

在初始化了这些数据结构、代码模块和系统寄存器之后，通过设置 CRO寄存器的保护模式标志 PE（位0），处理器就可以切换到保护模式下运行。

### 1.1 保护模式系统结构表

软件初始化期间在内存中设置的保护模式系统表主要依赖于操作系统将要支持的内存管理类型：平坦的、平坦并支持分页的、分段的或者分段并支持分页的。

为了实现无分页的平坦内存模型，软件初始化代码必须起码设置具有一个代码段和一个数据段的 GDT表。当然 GDT表第1项还需要放置一个空描述符。堆栈可以放置在普通可读写数据段中，因此并不需要专门的堆栈描述符。支持分页机制的平坦内存模型还需要一个页目录和至少一个页表。在可以使用GDT表之前，必须使用LGDT指令将GDT表的基地址和长度值加载到GDTR寄存器中。

而多段模型则还需要用于操作系统的其他段，以及用于每个应用的段和LDT表段。LDT表的段描述符要求存放在GDT表中。

### 1.2 保护模式异常和中断初始化

软件初始化代码必须设置一个保护模式IDT，其中最少需要含有处理器可能产生的每个异常向量对应的门描述符。若使用了中断或陷阱门，那么门描述符可以都指向包含中断和异常过程的同一个代码段。若使用任务门，那么每个使用任务门的异常处理过程都需要一个TSS以及相关代码、数据和堆栈段。若允许硬件产生中断，那么必须在IDT中为一个或多个中断处理过程设置门描述符。

在可以使用IDT之前，必须使用LIDT指令将IDT表基地址和长度加载到IDTR寄存器中。

### 1.3 分页机制初始化

在设置CR0中的PG标志之前（启用分页机制），必须先初始化以下数据结构和寄存器：

- 软件必须在物理内存中建立至少一个页目录和一个页表。若页目录中含有指向自身的目录项时，可以不使用页表。此时，页目录和页表被存放在同一个页面中。

- 将页目录表的物理基地址加载到CR3寄存器中（即PDBR寄存器）。

- 处理器处于保护模式下，若满足所有其他限制，则PG和PE标志可以同时设置。

为保持兼容性，设置PG标志（以及PE标志）时必须遵循以下规则：

- 设置PG标志的指令应该立即跟随一条JMP指令。

- 设置PG标志到跳转指令JMP之间的代码必须来自对等映射（即跳转之前的线性地址和开启分页后的物理地址相同）的一个页面上。

### 1.4 多任务初始化

若将要使用多任务机制，并且/或者允许改变特权级，那么软件初始化代码必须至少设置一个TSS以及相应的TSS段描述符（因为特权级0、1和2的各栈段指针需要从TSS中取得）。在创建TSS描述符时不要将其标注为忙，该标志仅由处理器执行任务切换时设置。与LDT段描述符相同，TSS的描述符也存放在GDT中。


