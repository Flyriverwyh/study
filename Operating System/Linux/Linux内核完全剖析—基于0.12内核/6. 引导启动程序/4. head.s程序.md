## 1. 功能描述

被编译成目标文件后会与内核其他程序一起被链接成system模块，位于system模块的最前面开始部分。system模块将被放在磁盘上setup模块之后开始的扇区中，即从磁盘上第6个扇区开始放置。一般Linux 0.12内核的system模块大约120KB左右，大约240个扇区。

从这里开始，内核完全在保护模式运行。head.s采用AT&T语法格式，并需要使用GNU的ga和gld编译连接，赋值是从左到右。

这段程序实际处于内存绝对地址0开始地方。程序功能比较单一。首先加载各个数据段寄存器，重新设置IDT，共256项，并使所有表项指向一个只报错误的哑中断子程序ignore\_int。格式如下。

![config](images/10.png)

中断描述符中段选择符是0x0008，表示该哑中断处理程序在内核代码中。偏移值被设置为ignore\_init中断处理程序在head.s程序中的偏移值。由于head.s被移动到内存地址0开始处，因此该偏移值也就是中断处理程序在内核代码段中的偏移值。由于内核代码段一直存在内存中，且特权级为0，即P=1，DPL=00。

设置好IDT后，又重新设置了GDT。新设的GDT表与原来的setup.s除了在段限长上有些区别（原8MB，现16MB），其他完全一样。当然可以在setup.s就把GDT段限长直接设置为16MB，然后直接把原GDT移动到合适内存为止。之前GDT处于内存0x902XX处。这个地方将在内核初始化后用作内存高速缓冲区的一部分。

接着使用物理地址0与1MB开始处字节比较，检测A20地址是否已开启。若没开，则访问高于1MB物理内存地址时CPU实际只会循环访问（IP MOD 1MB）地址处内容，即与访问从0地址开始对应字节的内容都相同。若发现没有开启，进入死循环。然后测试PC是否有数学协处理器（80287、80387等），并在控制寄存器CR0设置相应标志位。