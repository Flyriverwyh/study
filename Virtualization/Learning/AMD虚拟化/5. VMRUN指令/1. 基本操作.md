

VMRUN指令具有[rAX]的隐式寻址模式。软件必须使用VMCB的物理地址加载RAX（32位模式下的EAX），VMCB是一个4 KB对齐的页面，描述了要执行的虚拟机。 RAX用于形成地址的部分由当前有效地址大小确定。
VMCB通过物理地址访问，应映射为写回（WB）内存。
VMRUN仅在CPL 0处可用。如果CPL大于0，则会引发#GP（0）异常。此外，处理器必须处于保护模式，并且EFER.SVME必须设置为1，否则，将出现#UD异常被提出。
VMRUN指令在VM_HSAVE_PA MSR中指定的物理地址处，将一些主机处理器状态信息保存在主存储器中的主机状态保存区域中；然后从VMCB状态保存区域加载相应的来宾状态。 VMRUN还从VMCB读取其他控制位，这些控制位允许VMM刷新来宾TLB，向来宾中注入虚拟中断等。

然后，VMRUN指令检查刚加载的来宾状态。如果加载了非法状态，则处理器将返回主机（第15.6节）。
否则，处理器现在将运行来宾代码，直到发生拦截事件为止，这时处理器将挂起来宾执行并按照VMRUN之后的指令恢复主机执行。这称为#VMEXIT，并在第15.6节中进行了详细描述。
VMRUN保存或还原最少数量的状态信息，以允许VMM在来宾退出后恢复执行。这使VMM可以快速处理简单的拦截条件。如果必须保存或还原其他来宾状态信息（例如，处理更复杂的拦截或切换到其他来宾），则VMM必须使用VMLOAD和VMSAVE指令来处理其他来宾状态。 （请参阅第15.5.2节）。
SavingHostState。为确保主机可以在#VMEXIT之后继续运行，VMRUN至少保存以下主机状态信息：
•CS.SEL，NEXT_RIP-VMRUN之后的指令的CS选择器和rIP。在#VMEXIT上，主机将在该地址恢复运行。
•RFLAGS，RAX-主机处理器模式和VMRUN用于寻址VMCB的寄存器。
•SS.SEL，RSP-主机的堆栈指针。
•CR0，CR3，CR4，EFER-主机的分页/操作模式。
•IDTR，GDTR-伪描述符。 VMRUN不会保存或还原主机LDTR。
•ES.SEL和DS.SEL。

处理器实现可以在VM_HSAVE_PA MSR指向的存储区域中仅存储主机状态的一部分或不存储任何主机状态，并且可以将某些或全部主机状态存储在隐藏的片上存储器中。不同的实现方式可能会选择保存主机的段寄存器以及选择器的隐藏部分。由于这些原因，软件不得使用主机状态保存区的格式或内容，也不得尝试通过修改主机保存区的内容来更改主机状态。
LoadingGuestState。保存主机状态后，VMRUN从VMCB加载以下访客状态：
•CS，rIP-来宾从此地址开始执行。 CS段寄存器的隐藏状态也从VMCB加载。
•RFLAGS，RAX。
•SS，RSP-包括SS段寄存器的隐藏状态。
•CR0，CR2，CR3，CR4，EFER-访客分页模式。因为切换了地址空间，所以用VMRUN写入与页面相关的控制寄存器不会刷新TLB。 （第15.16节。）
•INTERRUPT_SHADOW-此标志指示访客当前是否处于中断锁定阴影中； （第15.21.5节）。
•IDTR，GDTR。
•ES和DS-包括段寄存器的隐藏状态。
•DR6和DR7-访客的断点状态。
•V_TPR-访客的虚拟TPR。
•V_IRQ-该标志指示虚拟中断是否在客户机中挂起。
•CPL-如果访客处于实模式，则CPL被强制为0；否则，则为0。如果guest虚拟机处于v86模式，则将CPL强制设置为3。否则，将使用VMCB中保存的CPL。
处理器检查加载的来宾状态的一致性。如果在加载来宾状态时一致性检查失败，则处理器将执行#VMEXIT。有关更多信息，请参阅第459页“规范化和一致性检查”。
如果根据刚刚加载的寄存器来宾处于PAE分页模式，并且未启用嵌套分页，则处理器还将读取新加载的CR3值所指向的四个PDPE。设置PDPE中的任何保留位也会导致#VMEXIT。
VMRUN指令有可能加载来宾rIP，该来宾rIP超出来宾代码段的限制或非规范（如果以长模式运行）。如果发生这种情况，则会在来宾内部传递一个#GP错误；超出访客代码段限制的rIP不会被视为非法访客状态。
加载所有来宾状态并设置拦截器和其他控制位后，处理器会通过将GIF设置为1来重新启用中断。假定VMM软件在执行VMRUN指令之前需要清除GIF，以确保原子状态切换。
某些处理器模型允许VMM将某些来宾VMCB字段指定为“干净”，这意味着它们尚未相对于当前硬件状态进行修改。这允许硬件优化VMRUN的执行。有关哪些字段可能受此影响的详细信息，请参见15.15节。下面的描述假定所有字段都已加载。
ControlBits。除了加载访客状态外，VMRUN指令还从VMCB读取多个控制字段；这些字段中的大多数都不会写回到#VMEXIT上的VMCB，因为它们在来宾执行期间无法更改：
•TSC_OFFSET-访客读取TSC（时间戳计数器）时要添加的偏移量。可以通过更改偏移量来拦截和模拟来宾写入TSC，而无需写入物理TSC。当访客退出主机时，将清除此偏移量。
•V_INTR_PRIO，V_INTR_VECTOR，V_IGN_TPR-用于描述来宾虚拟中断的字段（请参见第487页的“注入虚拟（INTR）中断”）。
•V_INTR_MASKING-控制是否要虚拟屏蔽中断（在EFLAGS.IF和TPR中）（第15.21节）。
•运行来宾时要使用的地址空间ID（ASID）。
•用于在VMRUN期间控制TLB刷新的字段（请参见第15.16节）。
•描述访客活动拦截的拦截向量。从来宾退出时，内部拦截寄存器将被清除，因此不会拦截任何主机操作。
