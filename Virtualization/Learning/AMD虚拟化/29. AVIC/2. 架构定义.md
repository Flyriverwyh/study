
以下各节介绍了AVIC的架构。

# 1. 虚拟LAPIC: Virtualizing the Local APIC

**guest虚拟处理器**通过读写位于**guest物理地址空间**中**4KB页面**中的**一组寄存器**来访问其LAPIC的功能。**AVIC硬件**通过将guest的尝试访问**重定向**到位于**系统物理地址**（System physical address, SPA）空间中的**vAPIC backing页面**来虚拟化此访问。

注: guest肯定访问的是guest自己的地址空间, 这里对lapic的访问使用的是物理地址, 所以是guest物理地址, 但是最终还是会落到真实的物理地址, 这部分也就是AVIC的工作.

**AVIC硬件**检测到**guest对其LAPIC寄存器集**的尝试**访问**，并将这些访问**重定向到vAPIC backing页面**。如下图所示。

![2020-09-07-09-37-12.png](./images/2020-09-07-09-37-12.png)

要将**虚拟机vAPIC寄存器的guest访问**正确重定向到vAPIC backing页面，该硬件需要**两个地址**。 这些是：
* **系统物理地址(SPA)空间**中的**vAPIC backing页面地址**
* **虚拟机物理地址(GPA)空间**中的**guest vAPIC基址**(APIC BAR)

**系统软件**负责在**嵌套页面表**(nested page table)中**设置转换关系**，以授予**guest读写**访问**SPA空间**中**vAPIC backing页面**的权限。AVIC硬件walks nested page table(嵌套页面表)以**检查权限**，但**不使用**在**叶子页表条目**中指定的**SPA地址**。而是，AVIC硬件在**VMCB**的`AVIC_BACKING_PAGE`指针字段中找到此地址。

VMM使用适当的**默认APIC寄存器值**（包括诸如**APIC版本号**之类的项目）初始化backing页面。vAPIC backing页面地址和guest vAPIC基址分别存储在VMCB字段`AVIC_BACKING_PAGE`**指针**和`V_APIC_BAR`中。

系统固件将**guest vAPIC基址**（和`VMCB.V_APIC_BAR`）的值初始化为`FEE0_0000h`。 **guest操作系统**在**引导**时希望在**此地址**找到**LAPIC寄存器集**。

如果**guest**尝试通过**写入APIC基址寄存器**（MSR `0000_001Bh`）来在**GPA空间**中**重新定位LAPIC寄存器基址**，则VMM应该**拦截该写操作**，以更新**guest VMCB**的`V_APIC_BAR`字段和虚拟机**嵌套页表**的**translation**中**GPA部分**内容。

在**guestVM的整个生命周期**中，vAPIC backing页必须存在于**系统物理内存**中，因为即使guest未运行，**某些字段也会更新**。

## 1.1. 虚拟APIC寄存器访问: Virtual APIC Register Accesses

**虚拟APIC寄存器访问**(Virtual APIC Register Accesses)。AVIC硬件检测到guest尝试访问backing页中的vAPI寄存器。这些尝试的访问由**寄存器级权限过滤器**(register-level permissions filter)处理, 使用下列三种方式之一处理：
* 允许(Allow). 允许完成对backing页面的访问。 **写入**将更新backing页面值，而**读取**将返回**当前值**。 在**某些情况**下，**写操作**会导致特定的**基于硬件的加速操作**（在表15-22中进行了汇总，并在下面进行了介绍）。不会发生`#VMEXIT`???
* 故障(Fault). **访问之前**处理器执行**SVM拦截**。 导致`#VMEXIT`。
* 陷阱(Trap). **访问完成后**，处理器立即**执行SVM拦截**。 导致`#VMEXIT`。

下表总结了**每个寄存器**的行为的详细信息：

![2020-09-07-20-13-12.png](./images/2020-09-07-20-13-12.png)

![2020-09-07-20-13-26.png](./images/2020-09-07-20-13-26.png)

此表中没有明确定义的其他寄存器, 是被允许(allow)读取和写入backing page. 不会发生`#VMEXIT`??

所有vAPIC寄存器均为32位宽，位于16字节对齐的偏移量处。 尝试读取或写入`[register_offset + 4：register_offset + 15]`范围内的任何字节的结果均未定义。

guest写入**任务优先级寄存器**（TPR），写入**中断结束**（EOI）寄存器和**中断命令寄存器低位**（ICRL）的特定使用情况会导致**特定的硬件操作**。由于该寄存器的写入没有立即的硬件副作用(`side-effect`)，因此AVIC硬件允许guest写入**中断命令寄存器高位**（ICRH）。 AVIC硬件维护并使用**处理器优先级寄存器**（PPR）中的值来**控制向guest虚拟处理器的中断传递**。 

以下各节讨论guest对vAPIC支持页面中的这些寄存器的访问处理。

### 1.1.1. 任务优先级寄存器: Task Priority Register(TPR)

任务优先级寄存器(Task Priority Register, TPR). 

* 当客户操作系统**写入TPR**时，该值会**在backing页中更新**，并且该值的**高4位**会由**硬件自动复制**到**VMCB**中的`V_TPR`值。 同样，使用`MOV CR8`语义的**任何TPR访问**都会**更新backing页**和`V_TPR`值。
* 所有读取TPR值均从**vAPIC backing页面返回**。


存储在**CR8**和`V_TPR`中的**优先级值**与**APIC TPR寄存器**的**格式不同**。仅仅任务优先级位(Task Priority)被保留在CR8和`V_TPR`的低4位。没有存储“任务优先级子类别(Task Priority Subclass)”值。**写入内存映射(memory-mapped)的TPR寄存器**更新CR8和V_TPR的`bits 3:0`，**写入CR8**更新TPR backing页值 `bits 7:4`，而 `bits 3:0`设置为零。

![2020-09-07-20-35-57.png](./images/2020-09-07-20-35-57.png)

TPR的“任务优先级”字段与CR8的“任务优先级”字段之间的同步是由AVIC模拟的常规本地APIC行为。 有关APIC的更多信息，请参见第567页上的第16章，“高级可编程中断控制器（APIC）”。

### 1.1.2. 处理器优先级寄存器: Processor Priority Register(PPR)

处理器优先级寄存器: Processor Priority Register(PPR)




### 1.1.3. 中断结束寄存器: End of Interrupt(EOI) Register

中断结束寄存器: End of Interrupt(EOI) Register


### 1.1.4. 中断命令寄存器低位: Interrupt Control Register Low(ICRL)

中断命令寄存器低位: Interrupt Control Register Low(ICRL)


# 2. AVIC对VMCB修改的支持: VMCB Changes in Support of AVIC

以下段落概述了定义在AVIC架构中的新VMCB字段部分。

## 2.1. VMCB控制字段: VMCB Control Word

**VMCB控制字段**(VMCB Control Word). AVIC在**VMCB控制字偏移量60h**处添加了**AVIC启用位**：

![2020-09-07-21-07-58.png](./images/2020-09-07-21-07-58.png)

AVIC Enable - 虚拟中断控制(Virtual Interrupt Control), `Bit 31`。可以在**每个虚拟处理器**的基础上**启用AVIC硬件支持**。该位确定**是否为特定的虚拟处理器启用了AVIC**。 配置为使用AVIC的任何guest也必须启用RVI（nested paging, 嵌套分页）。 启用AVIC会**隐式禁用**VMCB控制字中的`V_IRQ`，`V_INTR_PRIO`，`V_IGN_TPR`和`V_INTR_VECTOR`字段。

## 2.2. 新定义的VMCB域

AVIC利用VMCB中的许多**先前保留的位置**。 下面的表15-24列出了体系结构定义的新字段：

![2020-09-07-21-14-27.png](./images/2020-09-07-21-14-27.png)

![2020-09-07-21-14-38.png](./images/2020-09-07-21-14-38.png)

以下各段将进一步讨论这些字段：





# 3. AVIC内存数据结构

AVIC Memory Data Structures

AVIC体系结构定义了**三个新的内存驻留数据结构**。这些结构中的**每一个**都被定义为恰好适合**一个4 KB页面**。未来的实现可能会扩大规模。

## 3.1. 虚拟APIC backing页: Virtual APIC Backing Page

**虚拟APIC backing页**(Virtual APIC Backing Page)。系统中的**每个虚拟处理器**都分配有**一个虚拟APIC backing页面**（vAPIC backing page）。guest对guest物理地址空间中的LAPIC寄存器块的访问将重定向到系统内存中的vAPIC backing页面。 AVIC硬件和VMM使用vAPIC backing页面来模拟LAPIC。有关详细说明，请参见第517页的“虚拟APIC寄存器访问”。

## 3.2. 物理APIC ID表: Physical APIC ID Table

**物理APIC ID表**(Physical APIC ID Table)。物理APIC ID表由**VMM设置和维护**，并由**硬件**用于**定位适当的vAPIC backing页面**，该页面将用于根据**guest物理APIC ID**传递中断。**每个虚拟机**必须提供**一个物理APIC ID表**。

**guest物理APIC ID**用作此表的**索引**。每个条目都包含一个指向**虚拟处理器**的**vAPIC backing页面**的指针，一个指示**虚拟处理器**当前**是否已在物理CPU上调度**的位以及（如果是）该**物理CPU**的**物理APIC ID**。

该表的长度固定为**4 KB**，**每个虚拟机**最多允许**512个虚拟处理器**。但是，在此版本的体系结构中，**每个guest**的**虚拟处理器**的最大数量限制为**256**。可以使用**稀疏方式**(sparse manner)使用**有效位填充物理ID表**，以指示分配的ID。**最后一个有效条目**的**索引**存储在**VMCB** `AVIC_PHYSICAL_MAX_INDEX`字段中。

指向该表的指针在VMCB中维护。由于**每个虚拟机只有一个物理APIC ID表！！！**，因此对于虚拟机中的**每个虚拟处理器**，**此指针的值都相同**。

表中的每个条目具有以下格式：

![2020-09-07-21-28-33.png](./images/2020-09-07-21-28-33.png)

![2020-09-07-21-30-32.png](./images/2020-09-07-21-30-32.png)

请注意，IR位置1时表示VMM已分配一个物理核心来承载此虚拟处理器。 该位不区分以访客模式（主动执行访客软件）或以虚拟机监控程序模式（已暂停访客软件的执行）运行的物理处理器。

![2020-09-07-21-32-07.png](./images/2020-09-07-21-32-07.png)

由于将**目的地FFh**用于指定**广播**，因此保留了物理APIC ID FFh。 该表的高2048个字节已保留，应设置为零。

## 3.3. 逻辑APIC ID表: Logical APIC ID Table

LAPIC ID表(Logical APIC ID Table). 

除了物理APIC ID表之外，还为**每个guest VM**分配了**逻辑APIC ID表**。该表用于为逻辑寻址的中断请求查找**guest物理APIC ID**。该表的每个条目都提供与单个逻辑寻址APIC相对应的guest物理APIC ID。请注意，这意味着每个vAPIC的逻辑ID必须唯一。该表的条目使用逻辑ID进行选择，并根据guest的逻辑APIC寻址模式进行不同的解释。支持逻辑目标模式：平面集群。

如果访客尝试更改其APIC的逻辑ID，则VMM必须在逻辑APIC ID表中反映此更改。中航工业硬件支持针对一个或多个逻辑目标的固定中断消息类型。硬件还支持通过ICRL的目标速记（DSH）字段指定的自身和广播传递模式。 VMM必须通过仿真来支持其他任何消息类型。

# 中断传递: Interrupt Delivery

虚拟中断有两种基本类型：处理器间中断（IPI）和I / O设备中断（设备中断）。 guest系统软件写入ICRL寄存器时，将启动IPI。 设备中断由已由guest系统软件（通常是设备驱动程序）编程的I / O设备启动，以将表示事件的消息发送到特定的guest物理处理器。 该消息通常包括指示事件性质的中断向量号。
以下各节讨论当虚拟处理器发信号通知IPI时由AVIC硬件采取的措施，以及当设备发信号通知虚拟中断时由I / O虚拟化硬件采取的措施。

处理器间中断(Interprocessor Interrupts). 要处理IPI，AVIC硬件, 请执行以下步骤：

1. 如果命令中编码的 `destination-shorthand` 为01b（即self），请更新后备中的IRR
页面上，向自己发出门铃信号，并跳过其余步骤。
2.如果目标快捷方式不为零，或者目标字段为FFh（即广播），请跳至步骤4。
3.如果对目的地进行了逻辑寻址，请使用逻辑APIC ID表为每个逻辑ID查找来宾物理APIC ID。
如果该输入无效（V位被清除），则导致#VMEXIT。
如果该条目有效，但包含无效的后页指针，则导致#VMEXIT。