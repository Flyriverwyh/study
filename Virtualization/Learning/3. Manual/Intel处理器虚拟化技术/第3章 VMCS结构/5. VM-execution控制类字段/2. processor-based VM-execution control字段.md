

processor-based 控制字段提供基于处理器层面上的控制，两个这样的控制字段如下：

* primary processor-based VM-execution control 字段
* secondary processor-based VM-execution control 字段

这两个字段是 32 位向量值，每一位可以对应一个功能控制。在进入 `VMX non-root operation` 模式后，它们控制着虚拟处理器的行为。primary processor-based VM-execution  control 字段与一个 TRUE 寄存器对应，而 secondary processor-based VM-execution control 字段无须 TRUE 寄存器控制（参见 2.5.6 节）。

# primary processor-based VM-execution control 字段

处理器 VMX non-root operation 模式下的**主要行为**由这个字段控制，它的 `bit 31` 也控制是否启用 `secondary processor-based VM-execution control` 字段。

这个字段部分保留位为 **default1**（**固定**为 1 值），部分保留位为 **default0**（固定为 0 值). 需要通过 `IA32_VMX_PROCBASED_CTLS` 或 `IA32_VMX_TRUE_PROCBASED_CTLS` 寄存器来决定（见 2.5.6 节）。

在表 3-6 中，`bit 1`, `bits 6:4`, `bit 8`, `bits 14:13` 及 `bit 26` 固定为 1 值，bit0 及 bis18:17 固定为 0 值。其余可设置为 0 或 1 值，即关闭或开启某项控制。

<table>
 <caption><br><b>表3-6 Primary Processor-Based VM-Execution Controls的定义</b></br></caption>
    <tr>
        <th>位域</th>
        <th>控制名</th>
        <th>配置</th>
        <th>描述</th>
    </tr>
    <tr>
        <td>0</td>
        <td>保留位</td>
        <td>0</td>
        <td>固定为 0 值</td>
    </tr>
    <tr>
        <td>1</td>
        <td>保留位</td>
        <td>1</td>
        <td>固定为 1 值</td>
    </tr>
    <tr>
        <td>2</td>
        <td>
            Interrupt-window exiting
        </td>
        <td>0 或 1</td>
        <td>
            为 1 时，在 IF=1 并且中断没被阻塞时，产生 Vm-exit
        </td>
    </tr>
    <tr>
        <td>3</td>
        <td>
            Use TSC offsetting
        </td>
        <td>0 或 1</td>
        <td>
            为 1 时，读取 TSC 值时，返回的 TSC 值加上一个偏移值
        </td>
    </tr>
    <tr>
        <td>6:4</td>
        <td>保留位</td>
        <td>1</td>
        <td>固定为 1 值</td>
    </tr>
    <tr>
        <td>7</td>
        <td>
            HLT exiting
        </td>
        <td>0 或 1</td>
        <td>
            为 1 时，执行 HLT 指令产生 VM-exit
        </td>
    </tr>
    <tr>
        <td>8</td>
        <td>保留位</td>
        <td>1</td>
        <td>固定为 1 值</td>
    </tr>
    <tr>
        <td>9</td>
        <td>
            INVLPG exiting
        </td>
        <td>0 或 1</td>
        <td>
            为 1 时，执行 INVLPG 指令产生 VM-exit
        </td>
    </tr>
    <tr>
        <td>10</td>
        <td>
            MWAIT exiting
        </td>
        <td>0 或 1</td>
        <td>
            为 1 时，执行 MWAIT 指令产生 Vm-exit
        </td>
    </tr>
    <tr>
        <td>7</td>
        <td>
            HLT exiting
        </td>
        <td>0 或 1</td>
        <td>
            为 1 时，执行 HLT 指令产生 VM-exit
        </td>
    </tr>
    <tr>
        <td>7</td>
        <td>
            HLT exiting
        </td>
        <td>0 或 1</td>
        <td>
            为 1 时，执行 HLT 指令产生 VM-exit
        </td>
    </tr>
</table>


 为 1 时，执行 RDPMC 指令产生 VM-exit 为 1 时，执行 RDTSC 指令产生 VM-exit 固定为 1 值

为 1 时，写 CR3 寄存器产生 VM-exit 为 1 时，读 CR3 寄存器产生 Vm-cixt

固定为 0 值

为 1 时，写 CR8 寄存器产生 VM-exit 为 1 时，读 CR8 寄存器产生 VM-exit

为 1 时，启用“virtual APIC page”页面来虚拟化 local  APIC

为 1 时，开 virtual- NMI window时产生 VMexit 为 1时，读写 DR 寄存器产生 VM-exit

为1 时，执行 IN/OUT 或INSOUTS 类指产生 VM-exit 为 1 时，启用/O bima 固定为 1 值

为 1 时，启用 MTF 调试功能为 1 时，启用 MSR bitmap

# secondary processor-based VM-execution control 字段

随着处理器架构的不断发展，一些**新的 VMX 架构功能**也可能被不断地加入。这个字段就用于提供这些扩展的控制功能，或者说**新的 VMX 功能**，如表 3-7 所示。只有在  `primary processor-based VM-execution control` 字段的“`activate secondary controls`”位为 1 时才有效。否则，全部控制位关闭。

![2021-01-16-22-15-05.png](./images/2021-01-16-22-15-05.png)

这个字段的**保留位**为 **default0**（固定为 0 值）。软件通过 `IA32_VMX_PROCBASED_CTLS2` 寄存器来检查支持哪个控制位。当 `primary processor-based VM-execution control` 字段的 "`activate secondary control`"控制位为 0 时，这个字段无效。

## virtual APIC accesses

当“virtualize APIC accesses”为 1 时，将实施 local APIC 访问的虚拟化。它引入了个被称为“APIC-aceess page”的 4K 页面，这个 APlC-access page 的物理地址必须提供在 APIC-access address 字段里。

具体查看`7.2.x`部分

## enable EPT

