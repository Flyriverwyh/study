
# libvirt的架构

libvirt是CS架构应用，用户通过client与server交互，server与client通过socket连接通信。基本架构图如下所示：

![2019-11-23-11-01-45.png](./images/2019-11-23-11-01-45.png)

* libvirt分为**client**和**deamon**两个部分
* libvirt **deamon**中还包含了**rpc**、**acl**、**事件机制**、**线程池**等公共组件。
    * **基于rpc**可以实现**libvirt remote client**对本地虚拟机的操作。
    * **acl**实现了**访问控制标签**。
    * **事件机制**是libvirt**所有动作的基础**，所有的请求，消息转发，事件触发都是通过事件机制传递的。
* libvirt deamon中通过**事件机制**监听**某个端口**的消息。**client**发出的请求会通过**socket连接**发送到libvirt **api**。
* libvirt deamon在启动时会加载部署的hypervisor驱动，libvirt api接收到的请求会路由到conn对象指定的驱动程序中。
* 驱动程序接收到转发的请求之后会与hypervisor交互实现对虚拟机的具体操作。
* libvirt中目前实现了多种hypervisor的驱动，其中qemu_driver对应kvm，lxc对应容器。
* 对于kvm而言，一个虚拟机对应一个qemu进程。qemu进程通过软件模拟计算机的主板，CPU，南北桥及内存设备。虚拟机操作系统就运行在qemu进程内。
* libvirt独立实现了lxc driver来管理容器。lxc driver启动一个独立的进程并使用这个进程拉起一个init子进程，这个子进程有其独立的namespace并与cgroup结合实现了容器资源的隔离和限制。