
在 `inc\vmcs.inc` 文件中定义了 **VMB**，以及 VMCS 区域对应的 6 个 VMCS buffer 结构，分别为 GUEST_STATE、HOST_STATE、EXECUTION_CONTROL、EXIT_CONTROL、ENTRY_CONTROL 及 EXIT_INFO 结构。

PCB 结构的 GuestStateBuf, HostStateBuf, ExecutionConrolBuf, ExitControlBuf, EntryControlBuf 及 ExitInfoBuf 分别对应这些 VMCS buffer 结构



# VMB 结构

下面是 VMB 结构部分成员的定义。



# VSB 结构

VSB 结构同样定义在 `inc\vmcs.inc` 文件中, 定义如下.

```
;;
;; VSB（VM Storage Block，虚拟机存储块）
;;
struc VSB
        .Base                   RESQ            1
        .PhysicalBase           RESQ            1

        ;;
        ;; VM video buffer 管理记录
        ;;
        .VmVideoBufferHead      RESQ            1
        .VmVideoBufferPtr       RESQ            1
        .VmVideoBufferLastChar  RESD            1
        .VmVideoBufferSize      RESD            1
        
        ;;
        ;; VM keyboard buffer 管理记录
        ;;        
        ALIGNB 8
        .VmKeyBufferHead        RESQ            1
        .VmKeyBufferPtr         RESQ            1
        .VmKeyBufferSize        RESD            1
        

        ;;
        ;; guest 的 context 信息
        ;;
        .Context:
        .Rax                    RESQ            1
        .Rcx                    RESQ            1
        .Rdx                    RESQ            1
        .Rbx                    RESQ            1
        .Rsp                    RESQ            1
        .Rbp                    RESQ            1
        .Rsi                    RESQ            1
        .Rdi                    RESQ            1
        .R8                     RESQ            1
        .R9                     RESQ            1
        .R10                    RESQ            1
        .R11                    RESQ            1
        .R12                    RESQ            1
        .R13                    RESQ            1
        .R14                    RESQ            1
        .R15                    RESQ            1        
        .Rip                    RESQ            1
        .Rflags                 RESQ            1 

        ;;
        ;; FPU 单元 context
        ;;
        ALIGNB 16
        .FpuStateImage:
        .FpuEnvironmentImage:   RESB            28
        .FpuStackImage:         RESB            80

        ;;
        ;; XMM image 区域，使用于 FXSAVE/FXRSTOR 指令（512字节）
        ;;
        ALIGNB 16
        .XMMStateImage:         RESB            512


        ;;
        ;; VM keyboard buffer 区域，共 256 个字节，保存按键扫描码
        ;;
        .VmKeyBuffer            RESB            256
        .Reserve                RESB            4096 - $


        ;;
        ;; VM video buffer 区域，存放处理器的屏幕信息
        ;; 4K，存放约 25 * 80 * 2 信息
        ;;
        .VmVideoBuffer          RESB            (4096 * 2 - $)

        

        VM_STORAGE_BLOCK_SIZE           EQU     $
        VSB_SIZE                        EQU     $        
endstruc
```

VSB结构定义了三类存储区域, 分别为:

(1) VmKeyBuffer, 每个VM对应的键盘缓冲区

(2) VmVideoBuffer, 每个VM对应的 video 缓冲区

(3) context区域, 包括15个通用寄存器, RIP与RFLAGS, x87 FPU/MMX state区域以及XMM state区域.



# VMCS buffer 结构

VMM在初始化 VMCS 区域时, 并不直接向 VMCS 字段写入值, 而是先将值写入 VMCS buffer对应的值中, 然后在某个时刻统一将VMCS buffer数据刷新到VMCS区域.

PCB结构中的6个VMCS buffer分别对应VMCS的6个区域, 下面是 EXECUTION_CONTROL 结构的定义.

```

```

EXECUTION_CONTROL 结构中的每个成员与VMCS的VM-execution control区域字段是保持一致的. 同样, GUEST_STATE、HOST_STATE、EXIT_CONTROL、ENTRY_CONTROL及EXIT_INFO结构内的成员都与VMCS区域字段一一对应.