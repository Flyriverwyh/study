
当“use TPR shadow”为 1 时，引入了一个被称为“`virtual-APIC page`”的**影子页面**(shadow page)。这个影子页面与物理 APIC page 样是 4K 大小，是 local APIC 的虚拟页面。

* 当“`APIC-register virtualization`”为 1 时，`virtual-APIC page` 页面内存在**每个 local APIC 寄存器**对应的一份**影子数据**（即**虚拟 local APIC 寄存器**）。
* 当“`APIC-register virtualization`”为 0 时，还细分有下面的情况：
    * "`virtual-interrupt delivery`"为 0 时，只有偏移量为 **80H** 的 **VTPR** 寄存器(`virtual-TPR`）是有效的。**其他位置的数据属于无效**（不可访问）。
    * "`virtual-interrupt delivery`"为 1 时，除了偏移量为 **80H** 的 **VTPR** 寄存器外，还有偏移量为 **BOH** 的 **VEZOI** 寄存器（`virtual-EOI`），以及偏移量为 **300H** 的 **VICR** 寄存器（`virtual-ICR`）的**低 32 位**可以进行**写访问**，但**不能进行读访问**! **其他位置的数据属于无效**（不可访问）。

`virtual-APIC page` 页面的 64 位**物理地址**需要在 `virtual-APIC address` 字段里提供。这个 4K 的页面属于 VMCS 区城所引用的数据结构区域（例如 IO bitmap 与 MSR  bitmap), VMM 在初始化 VMCS 区域时需要为 VM 分配这样的一个 4K 页面。

注意：无论是虚拟化 **xAPIC** 模式还是 **x2APIC** 模式，都会存在 `virtual-APIC page` 页面。

1. 虚拟 local APC 寄存器

`virtual-APIC page` 页面内存在物理 local APIC 对应的一份虚拟寄存器。表 7-2 列出了可访问的虚拟 local APIC 寄存器.



如前面所述，只有在“`APIC-register virtualization`”为 1 时，表中**所有的虚拟寄存器是可访问的**。

“`APIC-register virtualization`”与“`virtual-interrupt delivery`”都为 **0** 时，只有 **VTPR** 是**可访问**的。

“`APIC-register virtualization`”为 **0** 且 "`virtual-interrupt delivery`"为 **1** 时，只有 **VTPR**(**读/写**), **VEOI**(**只写**)以及 **VICR**(偏移量 300H，**只写**)是可访问的。

部分 local APIC 对应的虚拟寄存器是**不可访问**的，譬如偏移量为 **AOH** 的 **VPPR**(`virtual processor-priority register`，**虚拟处理器优先级别寄存器**）。尝试访问则产生 VM-exit。

2. APIC-access page 与 virtual-APIC page 的关系

`APIC-access page` 与 `virtual-APIC page` 之间的关系类似于**页映射**中的**虚拟地址**与**物理地址**。当 **guest** 尝试**线性**访问 `APIC-access page` 页面时（**不**包括 **guest-physical 访问**与**物理访问**），实际上访问了 `virtual-APIC page` 页面的数据。如图 7-7 所示。

![2021-01-03-13-49-02.png](./images/2021-01-03-13-49-02.png)

当启用了`virtual-APIC page`和`use TPR shadow`后, 如上图 7-7 所示guest尝试线性访问 TPR 寄存器, 处理器返回的是 virtual-APIC page 页面内的 VTPR 寄存器值.

当 guest 尝试以 guest-physical 方式访问 APIC- access page 页面时，不能得到 virtual  APIC page 页面内的虚拟寄存器数据，而是产生 Vm-exit。以物理方式访间时可能会访问

n△ WM it

3. Local APIC MSR 与 irtual- APIC page 的关系

当使用 x2APIC 模式虚拟化机制时，guest 访问 local APIC MSR 同样访问到 virtual  APIC page 页面内的虚拟寄存器。如同图 7-7 所示，所不同的是通过 MSR 来访问 local APIC 物理页面。

 7.2.6 Apic-access Vm-exit

当“virtualize APIC accesses 为 1 时，guest 尝试进行下面的访问将产生 VM-exit 这个 VM- -exit 可称为“APIC- access Vm-exit。

 (1) 尝试线性访间（包括读和写）APIC- access page 页面内不支持的 offset 位置将产  4E Apic-access Vm-exit

当“use TPR shadow”为 0 时，所有的 offset 位置都不支持。

当“use TPR shadow“为 1, 且“APIC- register virtualization“与“virtual- -Interrupt  delivery 都为 0 时，仅有 offset 为 80H 位置（TPR）被支持

当“use TPR shadow 为 1, 且“APIC- -register virtualization”为 0, " virtual-  interrupt delivery”为 1 时，支持下面的访问： offset 为 80H 位置（TPR）支持读写

 offset 为 B 位置（EOI）与 300H 位置（ICR 低 32 位）支持写访问。

当“use TPR shadow 为 1, 且“APIC- register virtualization 为 1 时，表 7-2 中所列的所有 offset。位置可访问。

 (2) 尝试 guest-physical i 访问（包括读和写）APIC- access page 页面内任何的 offset 位置将产生 APC- access Vm-exit

《（Intel 手册》明确表明：guest 尝试 physical access（物理访问）APC- access page 页面可能会也可能不会产生 Vm-exit。当不产生 APIC- access Vm-exit 时，可能会访问到  virtual- APIC page 页面内的数据。

7.2.6.1APIC- access Vm-exit 优先级别

当 guest 尝试访问 APIC- access page 页面时，可能会存在多个引发 Vm-exit 或其他事件的条件。例如下面的代码。

 mov eax,  [ebx+ LAPIC_ID 读取 APICID 值

在上面的代码里，guest 尝试通过线性地址读取 local APIC 的 ID 寄存器值。这条指令可能会产生多个异常。例如：它可能由于地址的 offset 值超过了 DS 的 limit 而产生#GP