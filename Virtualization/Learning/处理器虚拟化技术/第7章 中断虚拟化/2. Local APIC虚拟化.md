
每个逻辑处理器都有自己的local APIC组件. 当guest读取local APIC寄存器时, 将返回物理的local APIC寄存器值. 同样, 当guest写local APIC寄存器时, 也将写入物理的local APIC寄存器.

# 监控guest访问local APIC

# local APIC虚拟化机制

前面一节介绍的local APIC虚拟化原理是使用EPT映射机制或MSR bitmap机制来监控guest访问local APIC页面, 并模拟写入和读取local APIC寄存器.

VMX引进了原生的local APIC虚拟化机制, 由VMCS的secondary processor-based VM-execution control字段提供下面的功能.

- Virtualize APIC accesses(虚拟化APIC访问). 当"**virtualize APIC accesses**"位(bit 0)为1时, 将启用APIC\-access page页面. 处理器虚拟化guest线性访问APIC-access page页面的行为, 取决于"APIC-register virtualizaion"位的设置, 产生两种结果:
    - 产生APIC access VM-exit, 或者APIC write VM-exit(见7.2.8).
    - 成功访问virtual-APIC page页面的数据, 或者虚拟化某项操作(比如EOI虚拟化).
- Virtualize x2APIC mode(虚拟化x2APIC模式). 
- Use TPR shadow(启用TPR影子).
- APIC-register virtualization(APIC寄存器虚拟化).
- Virtua-interrupt delivery(虚拟中断的提交).
- Posted-interrupt processing(通告的中断处理).

# APIC-access page

# 虚拟化x2APIC MSR组

# virtual-APIC page

# APIC-access VM-exit

# local APIC虚拟化操作

# 虚拟中断的评估与delivery

# posted-interrupt处理

posted-interrupt