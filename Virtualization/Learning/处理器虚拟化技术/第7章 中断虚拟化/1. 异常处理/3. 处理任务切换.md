
# 

在 `VMX non-root operation` 模式内，尝试 **TSS 机制**的**任务切换**会产生 `VM-exit`。包括下面的途径：

* guest 使用 TSS selector 或者 Task- gate selector 作为 far pointer 来执行 CALL、JMP 指。

* guest 执行 IRET 指令时, 由于 EFLAGS.NT=1 而发起任务切换。

* 在一个向量事件（中断或异常）delivery 期间尝试任务切换，即向量号在 guest IDT 对应的描述符是 task-gate 描述符。

由于 VMX 不支持 guest 进行任务切换（利用 TSS 机制），因此在 guest 由于尝试进行任务切换而产生 VM-exit 时，VMM 需要模拟 guest 的任务切换来代替处理器的操作（guest 运行在 legacy 模式下）。

VMM 整个模拟任务切换的过程大致可以分为三个阶段

(1) 处理器检查是否满足任务切换条件阶段。

(2) VMM 模拟处理器任务切换阶段。

(3) VMM 根据情况进行 guest 相应恢复执行阶段。

其中，在第 2 阶段的任务切换处理非常烦琐。而在第 3 阶段里，VMM 需要根据情况反射一个异常给 guest 处理，或者跳转去执行 guest 的新任务。第 1 阶段的工作由处理器自动完成，主要是检查是否允许进行任务切换。7.1.3.1 检查任务切换条件

进行 TS 任务切换是一个非常复杂的过程，在 Iong-mode (A-32c）模式下处理器不支持 TSS 的任务切换机制。在由于任务切换而导致 Vm-exit 之前，处理器进行一系列的检查，确认满足任务切换的条件。如果检查不通过则引发异常，如果检查通过则产生  Vm-exit.

1. 使用 TSS selector 进行任务切换

CALL 或 JMP 指令使用 TSS selector 作为 far pointer 进行任务切换时，处理器进行下面的检查。

 (1) 检查 selector 是否为 NULL selector。属于 NULL selector 时产生#GP 异常。

 (2) 检查 selector 是否超过描述符表的 limit。超过 limit 则产生#GP 异常。

 (3) 读取描述符进行类型检查：

属于 TSS 描述符，在 1A-32e 模式下则产生#GP 异常

属于其他不支持的类型（非代码段描述符、TSS 描述符以及 Task-gate 描述符），则产生#GP 异常。