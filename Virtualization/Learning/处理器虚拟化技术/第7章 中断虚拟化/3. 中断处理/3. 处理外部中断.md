


对于外部中断，处理器可以接收从**中断控制器**（**8259**、**I0APIC** 或者 **local APIC**）来的中断请求，也可以接收来自**处理器间**以 **Fixed delivery** 模式发送的 **IPI** 消息。

# 拦截外部中断

VMM 设置 **VM-execution 控制类字段**中 `pin-based VM-execution control` 字段的“`external-interrupt exiting`” 位为 1, 当处理器收到**未被屏蔽及阻塞的中断请求**时，将直接产生 `VM-exit`。

当虚拟机发生 VM-exit 后, 可以通过清除 `RFLAGS.IF` 来屏蔽中断. 

由**外部中断**产生的 `VM-exit` **不能**被 `eflags.IF` 标志位屏蔽，但可以被 local APIC 的 **TPR** 屏蔽.

在拦截外部中断产生 VM-exit 后，取决于 VM exit control 字段“acknowledge interrupt  on exit”位的设置，VMM 有不同的应对处理。

“acknowledge interrupt on exit”为 1 时，在 VM-exit 时处理器响应中断控制器，从中断控制器里取出外部中断的信息，记录在 VM- exit interruption information 字段里（参见 3.10.2.1 节）。

“acknowledge interrupt on exit”为 0 时，外部中断在中断控制器 IRR (Interrupt  equest register）里的请求位保持有效，中断被悬挂着，VM- exit interruption  information 字段属于无效。VMM 执行 STI 指令后重新打开中断时，处理器才响应中断控制器取得中断向量号。

当 VMM 想夺取对外部中断 delivery 的控制权时，需要设置“acknowledge interrupt

 on exit”为 0, 发生 VM-exit 后，VMM 在重新打开中断许可时（执行 STI 或 POPF 指令），处理器响应中断控制器并通过 host-IDT 进行外部中断的 delivery 操作。

VMM 需要反射外部中断给 guest 处理时，则需要设置“acknowledge interrupt on