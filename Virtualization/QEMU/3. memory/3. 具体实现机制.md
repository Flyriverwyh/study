

# 整体概述

qemu部分的内存申请流程上可以分为三小部分，分成三小部分主要是我在看代码的时候觉得这三部分耦合性不是很大，相对而言比较独立。

众所周知，qemu起始于vl.c中的main函数，那么这三部分也按照在main函数中的调用顺序分别介绍。

# 回调函数的注册

涉及函数：`configure_accelerator() -->kvm_init()-->memory_listener_register ()`

这里所说的accelerator在这里就是kvm，初始化函数自然调用了`kvm_init`，该函数主要完成对**kvm的初始化**，包括一些常规检查如CPU个数、kvm版本等，还会通过ioctl和内核交互**创建kvm结构**，这些并非本文重点，不在赘述。在`kvm_init`函数的结尾调用了`memory_listener_register`

```cpp
memory_listener_register(&kvm_memory_listener, &address_space_memory);
memory_listener_register(&kvm_io_listener, &address_space_io);
```

通过`memory_listener_register`函数，针对地址空间注册了lisenter,lisenter本身是一组函数表，当地址空间发生变化的时候，会调用到listener中的相应函数，从何保持内核和用户空间的内存信息的一致性。虚拟机包含有两个地址空间address_space_memory和address_space_io，很容易理解，正常系统也包含系统地址空间和IO地址空间。

memory_listener_register函数不复杂，咱们看下