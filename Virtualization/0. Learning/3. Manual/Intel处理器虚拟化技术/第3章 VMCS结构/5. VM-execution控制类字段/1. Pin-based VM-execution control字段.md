
Pin-based VM-execution control 字段是一个 32 位向量, 提供基于处理器 **Pin 接口的控制**（`INTR` 与 `NMI`），也就是与**外部中断**和 **NMI** 相关的配置（包括一些特色功能），如表 3-5 所示。

表3-5

<table>
  <tr>
    <th>位域</th>
    <th>控制名</th>
    <th>配置</th>
    <th>描述</th>
  </tr>
  <tr>
    <td>0</td>
    <td>external-interrupt exiting</td>
    <td>0或1</td>
    <td>为1时, 发生外部中断则会产生VM-exit</td>
  </tr>
  <tr>
    <td>2:1</td>
    <td>保留位</td>
    <td>1</td>
    <td>固定为1</td>
  </tr>
  <tr>
    <td>3</td>
    <td>NMI exiting</td>
    <td>0或1</td>
    <td>为1时, 发生NMI则会产生VM-exit</td>
  </tr>
  <tr>
    <td>4</td>
    <td>保留位</td>
    <td>1</td>
    <td>固定为1</td>
  </tr>
  <tr>
    <td>5</td>
    <td>virtual NMIs</td>
    <td>0或1</td>
    <td>为1时, 定义virtual NMI</td>
  </tr>
  <tr>
    <td>6</td>
    <td>activate VMX-preemption timer</td>
    <td>0或1</td>
    <td>为1时, 启用VMX-preemption定时器</td>
  </tr>
  <tr>
    <td>7</td>
    <td>process posted-interrupt</td>
    <td>0或1</td>
    <td>为1时, 启用posted-interrrupt processing机制处理虚拟中断</td>
  </tr>
  <tr>
    <td>31:8</td>
    <td>保留位</td>
    <td>0</td>
    <td>固定为0</td>
  </tr>
</table>

在这个字段中，`bits 2:1` 及 `bit 4` 属于 **default1** 位（保留位为 1), `bits 31:8` 属于Default0 位（保留位为 0），软件需要根据 `IA32_VMX_PINBASED_CTLS` 与 `IA32_VMX_TRUE_PINBASED_CTLS` 寄存器来确定（参见 2.5.6.1 节）

# external-interrupt exiting

当“external-interrupt exiting”为 1 时，处理器接收到一个未被阻塞的 external-interrupt 请求时将产生 VM-exit

注意：F 标志位不能影响 VM-exit（即使 IF=0），但是处理器的 shutdown 及 wait- or-SIPI 状态能阻塞外部中断产生 VM-exit（参见 4.17.2 节及 4.16.3 节）

另外，local APIC 的本地中断能被 LVT mask 位（bit16) 及 TPR 寄存器屏蔽，而使用 Fixed delivery 模式的 IPI 能被 TPR 寄存器屏蔽。在这种情况下不能产生 Vm-exit。

当“external- Interrupt exiting”为 0 时，未被屏蔽与阻塞的外部中断则通过 guestDT 提交给处理器执行中断服务例程。

当 VM-exit control 字段中的“acknowledge interrupt on exit”也为 1 时，在退出 VM 时，处理器会响应中断控制器取得中断向量号，并在 VM- exit interruption information 字段中保存这个中断向量号及中断类型等相关信息（参见 3.7 节）。

VM-exit 将返回到 VMM，处理器会自动清 EFLAGS 寄存器（除了 bit1 固定为 1 值外）。这个特性使得 VMM 能够夺取外部中断的 delivery。当“acknowledge interrupt on exit”为 0 时，VMM 使用 STI 指令重新打开 Interrupt- window 时，处理器会响应这个外部中断并取得中断向量号，然后通过 host-IDT 来提交中断处理。

# NMI exiting

当“NMI exiting”为 1, 并且不存在“blocking by NMI”阻塞状态时，VMX non-root operation 内收到 NMI 将引发 Vm-exit 产生。为 0 时，则通过 guest-IDT 的 vector2 来提交 NMI 处理。

# virtual NMIS

只有 NMI exiting”为 1 时，“virtual NMIS”位才能被置为 1。当“virtual NMIS”位为 1 时，产生了一个 virtual-NMI 的概念。interruptibility- state 字段的“blocking by NMI”位此时将视为“blocking by virtual-NMI 位，记录着 virtual-NMI 是否被阻塞（参见 3.8.6 节）

 virtual-NMI 的 delivery 是通过事件注入方式实现的。当注入一个 virtual-NMI 时，如果这个 virtual-NM 在 delivery 期间遇到一个错误导致 VM-exit，此时“blocking by virtual NMI“”位被置位，指示 virtual-NMI 被阻塞。

 NMI exiting”位影响到 IRET 指令对 NMI 与 virtual-NMI 阻塞状态的解除作用

 (1) 当“NMI exiting 为 1 时，由于发生 NMI 会产生 Vm-exit, IRET 指令不能被认为在 NMI 服务例程内执行。因此，IRET 指令的执行对 NMI 阻塞状态不产生影响。




# activate VMX-preemption timer

当`activate VMX-preemption timer`位为1时, 启用VMX提供的定时器功能. VMM 需要在 `VMX-preemption timer value` 字段里为 **VM** 提供一个**计数值**。这个计数值在 `VM-entry` 操作**开始时**就进行**递减**，当减为 0 时产生 `VM-exit`。递减的步伐依赖于 **TSC** 及 `IA32_VMX_MISC[4:0]` 值（见 2.5.11 节）。



