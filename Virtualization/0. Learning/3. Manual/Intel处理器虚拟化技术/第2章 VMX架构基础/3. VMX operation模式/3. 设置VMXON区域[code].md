
### 1.1.2. 创建虚拟机阶段

> 如果能走到创建虚拟机, 说明模块初始化成功, 也就是上面的判断通过了

在**创建虚拟机过程**中, 会对所有物理CPU都会开启虚拟化功能

```cpp
用户态ioctl(fd,KVM_CREATE_VM,..)
kvm_dev_ioctl() // kvm ioctl 指令入口
 ├─ kvm_dev_ioctl_create_vm() // 创建虚拟机
 |   ├─ kvm_create_vm() // 实现虚拟机创建的主要函数
 |   |   ├─ hardware_enable_all() // 使能硬件，架构相关操作
 |   |   |   └─ on_each_cpu(hardware_enable_nolock, NULL, 1); // 对所有cpu调用hardware_enable_nolock方法, 从 hardware_enable_all 调用过来的话只会执行一次
 |   |   |       └─ kvm_arch_hardware_enable() //  
 |   |   |           ├─ kvm_x86_ops->hardware_enable()  // 打开硬件功能, 会调用 vmxon 指令
 |   |   |           |   ├─ kvm_cpu_vmxon()  // vmxon打开VMX模式
```

```cpp

static int hardware_enable(void)
{
        int cpu = raw_smp_processor_id();
        u64 phys_addr = __pa(per_cpu(vmxarea, cpu));
        ......
        r = kvm_cpu_vmxon(phys_addr);
        if (r) {
                intel_pt_handle_vmx(0);
        ......
}

