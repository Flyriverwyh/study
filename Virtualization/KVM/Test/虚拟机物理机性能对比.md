
# 确认物理机环境

```
# lscpu
Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                80
On-line CPU(s) list:   0-79
Thread(s) per core:    2
Core(s) per socket:    20
Socket(s):             2
NUMA node(s):          2
Vendor ID:             GenuineIntel
CPU family:            6
Model:                 85
Model name:            Intel(R) Xeon(R) Gold 6148 CPU @ 2.40GHz
Stepping:              4
CPU MHz:               2400.000
BogoMIPS:              4804.71
Virtualization:        VT-x
L1d cache:             32K
L1i cache:             32K
L2 cache:              1024K
L3 cache:              28160K
NUMA node0 CPU(s):     0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70,72,74,76,78
NUMA node1 CPU(s):     1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55,57,59,61,63,65,67,69,71,73,75,77,79

# cat /proc/cmdline
BOOT_IMAGE=/boot/vmlinuz-3.10.0-693_59.tl2 root=/dev/sda1 ro console=tty0 vconsole.keymap=us vconsole.font=latarcyrheb-sun16 i8042.noaux net.ifnames=0 biosdevname=0 intel_idle.max_cstate=1 intel_pstate=disable cgroup_disable=memory crashkernel=768M LANG=C hugepagesz=1G default_hugepagesz=1G hugepages=346
```


```
# systemctl stop numad.service ksm.service ksmtuned.service
# systemctl status numad.service ksm.service ksmtuned.service

# echo never > /sys/kernel/mm/transparent_hugepage/enabled
# cat /sys/kernel/mm/transparent_hugepage/enabled
always madvise [never]
```

* 下发子机

```
{
  "params": {
    "content": {
      "requestInfo": {
        "caller": "des",
        "operator": "des",
        "requestId": "145829440815388",
        "requestKey": "mx_ksdionuj3djfk",
        "requestModule": "qcloud",
        "seqId": "14582944072796"
      },
      "requestItem": {
        "data": {
          "affinity": 1,
          "agentList": {
            "monitor": 1,
            "security": 1
          },
          "alarmLevel": "L3",
          "appId": "251008809",
          "uin":3432146168,
          "hostIpList": [
            "9.32.175.116"
          ],
          "vpcId": 76768,
      "vpcSubnetId":1292256,
          "bg": "qcloud",
          "bkOperator": "gerryhwli",
          "business1": "[N][腾讯云云平台产品质量其它]",
          "business2": "[合作机房子机][测试子机]",
          "business3": "[公共][测试]",
          "businessId": "356693",
          "cacheImage": 0,
          "caller": "des",
          "hypervisor": "kvm",
          "cbsModule": 0,
          "cbsShortTermFlag": 0,
          "cbsSnapshot": 0,
          "cpu": 40,
          "cpuMode": "host-passthrough",
          "department": "互联网业务系统",
          "deptId": 10,
          "eventId": 12319830,
          "expired": 1800,
          "group": "SNS-game运维组",
          "groupId": 343,
          "lanIp": 1,
          "maxCount": 1,
          "mem": 307200,
          "optionalInfo": {
            "passwd": "isd@cloud",
            "username": "root"
          },
          "priOperator": "gerryhwli",
          "requestId": "145829440715388",
          "seqId": "14582944072796",
          "serverStatusId": 17,
          "type": "VSELF_4",
          "vmmRandom": 0,
          "cloudinit": "support",
          "volume": [
            {
              "custom": 1,
              "osName": "centos7.2x86_64",
              "partitionType": "ROOT",
              "rawRootTag": "rawRootDisk",
              "size": 50,
              "target": "xvda",
              "type": "standard"
            }
          ],
          "pinType": 3
        },
        "method": "instance_launch"
      },
      "type": "Json",
      "version": "1.0"
    }
  }
}
```


* 物理机的native os和虚拟机native os保持一致

物理机

```
# cat /etc/redhat-release
CentOS Linux release 7.2 (Final)
```

虚拟机

```
# cat /etc/redhat-release
CentOS Linux release 7.2.1511 (Core)
```

* 虚拟机和物理机内核重新编译(使用upstream代码), 即两个使用同一个.config文件

编译过程

物理机:

```
# uname -r
3.10.0-693_59

# cp /boot/config-3.10.0-693_59 /data/linux/.config

# make oldconfig
# make all -j80
# make modules_install
# make install
```

编译保证`CONFIG_NO_HZ_IDLE=y`选项

虚拟机同理

* host和vm都开启1G大页

系统启动参数

```
hugepagesz=1G default_hugepagesz=1G hugepages=346
```

```
cat /proc/meminfo|grep Huge 
```

```
virsh vcpupin 7 0 1
virsh vcpupin 7 1 3
virsh vcpupin 7 2 5
virsh vcpupin 7 3 7
virsh vcpupin 7 4 9
virsh vcpupin 7 5 11
virsh vcpupin 7 6 13
virsh vcpupin 7 7 15
virsh vcpupin 7 8 17
virsh vcpupin 7 9 19
virsh vcpupin 7 10 21
virsh vcpupin 7 11 23
virsh vcpupin 7 12 25
virsh vcpupin 7 13 27
virsh vcpupin 7 14 29
virsh vcpupin 7 15 31
virsh vcpupin 7 16 33
virsh vcpupin 7 17 35
virsh vcpupin 7 18 37
virsh vcpupin 7 19 39
virsh vcpupin 7 20 41
virsh vcpupin 7 21 43
virsh vcpupin 7 22 45
virsh vcpupin 7 23 47
virsh vcpupin 7 24 49
virsh vcpupin 7 25 51
virsh vcpupin 7 26 53
virsh vcpupin 7 27 55
virsh vcpupin 7 28 57
virsh vcpupin 7 29 59
virsh vcpupin 7 30 61
virsh vcpupin 7 31 63
virsh vcpupin 7 32 65
virsh vcpupin 7 33 67
virsh vcpupin 7 34 69
virsh vcpupin 7 35 71
virsh vcpupin 7 36 73
virsh vcpupin 7 37 75
virsh vcpupin 7 38 77
virsh vcpupin 7 39 79

# virsh vcpuinfo 7
```

注意: 修改xml重启虚拟机会丢失网络信息, 所以使用virsh命令


# 虚拟机

