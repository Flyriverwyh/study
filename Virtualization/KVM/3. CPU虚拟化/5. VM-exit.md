

在虚机启动之后正常运行的过程中，虚机就是在不断的经历ioctl进入，返回，进入，返回的循环过程，如下面的伪码所示。

```cpp
open("/dev/kvm")
ioctl(KVM_CREATE_VM)
ioctl(KVM_CREATE_VCPU)
for (;;) {
     ioctl(KVM_RUN)
     switch (exit_reason) {
     case KVM_EXIT_IO:  /* ... */
     case KVM_EXIT_HLT: /* ... */
     }
}
```

上述伪码是在用户空间中QEMU代码的实现模型，在内核中的KVM实现中，相关代码和用户空间类似，也是在进入虚机运行，等待虚机退出之后，会依据退出事件类型调用不同的处理钩子函数。唯一不同的是，如果退出事件内核判断**内核层就可以处理完毕**，就**不需要**再退出到**用户层**处理，而是直接在内核层就直接转入虚机运行态。这个过程如下图所示：

![2020-04-23-21-47-08.png](./images/2020-04-23-21-47-08.png)

虚机的退出事件处理是虚机能正常运行的必要条件，对虚机运行意义重大，

一个方面是**退出事件**的处理过程**消耗**对虚机性能表现**影响巨大**，例如virtio本质上也是为了解决频繁的退出事件对虚机的影响提出的优化解决方案，

另一方面是退出事件是对**虚机运行情况最直观的反映**，因为虚机在进入vt-x模式之后，里面的运行情况外部来看其实是一个黑盒，只有虚机在触发一定条件后退出vt-x模式，宿主机才可以通过退出时携带的**状态数据**推测出当前虚机运行的关键信息，进而可以**定位或者解决问题**。

# VM-EXIT事件

触发虚机退出的事件有很多，罗列如下：

FAILED_VMENTRY、EXCEPTION_NMI、EXTERNAL_INTERRUPT、TRIPLE_FAULT、PENDING_INTERRUPT、NMI_WINDOW、TASK_SWITCH、CPUID、HLT、INVD、INVLPG、RDPMC、RDTSC、VMCALL、VMCLEAR、VMLAUNCH、VMPTRLD、VMPTRST、VMREAD、VMRESUME、VMWRITE、VMOFF、VMON、CR_ACCESS、DR_ACCESS、IO_INSTRUCTION、MSR_READ、MSR_WRITE、INVALID_STATE、MSR_LOAD_FAIL、MWAIT_INSTRUCTION、MONITOR_TRAP_FLAG、MONITOR_INSTRUCTION、PAUSE_INSTRUCTION、MCE_DURING_VMENTRY、TPR_BELOW_THRESHOLD、APIC_ACCESS、EOI_INDUCED、GDTR_IDTR、LDTR_TR、EPT_VIOLATION、EPT_MISCONFIG、INVEPT、RDTSCP、PREEMPTION_TIMER、INVVPID、WBINVD、XSETBV、APIC_WRITE、INVPCID、PML_FULL、XSAVES、XRSTORS。

但在虚机的正常运行过程中，最常见的大概有那么几个，后面部分会分不同小结对此进行陈述。

# 辅助工具

要**跟踪虚机的退出事件**，需要使用必要的工具，参考虚机退出的处理流程，相对的可以有**不同的工具**来辅助处理。例如在**内核层截获**这个**退出事件**可以使用**perf工具**或者使用**SystemTap**，在**用户层截获**退出事件并调试可以参考使用**gdb工具**。

perf及gdb都是比较好用的工具，功能比较强大，详细使用可以参考帮助手册。

## Perf

Perf是一个linux平台上的性能调优工具，多用于软件性能分析，安装和使用Perf非常的容易。Perf主要是利用**PMU**、**tracepoint**和内核中的**特殊计数器**来进行**事件统计**，通过这个可以**定位性能问题**，也可以作为**探测工具**用于发现系统的一些其他**运行信息**。

这是使用Perf工具对虚机运行情况的一次跟踪，从信息可以看出虚机在这段时间内，是有很多次不同事件引起了vm-exit。

![2020-04-23-22-35-13.png](./images/2020-04-23-22-35-13.png)

## GDB

Gdb是GNU开源组织发布的一个强大的UNIX下的程序调试工具。我们在这里提到使用Gdb跟踪vm-exit事件主要是考虑可以跟踪进入ioctl之后退出逻辑的处理，在这个退出逻辑里，可以使用Gdb跟踪用户层程序qemu对于vm-exit事件的处理流程。

## Qemu-event



# 参考

https://cloud.tencent.com/developer/news/210058