

# 整体介绍

`Virtualization/Learning/KVM实战: 原理、进阶与性能调优/第3篇 KVM虚拟化技术/第5章 qemu-kvm虚拟化解决方案/5. KVM内核模块重要流程的分析.md`

![2019-12-11-11-04-37.png](./images/2019-12-11-11-04-37.png)

```
vmx_init()                               // 初始化入口
 ├─ kvm_init(KVM_GET_API_VERSION)        // 初始化KVM框架
 |   ├─ kvm_arch_init()                  // 架构相关初始化
 |   |   ├─cpu_has_kvm_support()         // CPU是否支持kvm 
 |   |   ├─disabled_by_bios()            // bios是否禁用vt
 |   |   ├─boot_cpu_has()                // CPU是否支持一些特性
 |   |   ├─kmem_cache_create("x86_fpu")  // 
 |   |   ├─alloc_percpu()                // CPU是否支持一些特性
 |   |   ├─kvm_mmu_module_init()         // CPU是否支持一些特性
 |   |   ├─kvm_timer_init()              // CPU是否支持一些特性
 |   ├─ kvm_irqfd_init()                 // 初始化KVM框架
 |   ├─ kvm_arch_hardware_setup()        // 初始化KVM框架
 |   ├─ smp_call_function_single()       // 对每个online cpu
 |   ├─ cpuhp_setup_state_nocalls()      // 初始化KVM框架
 |   ├─ register_reboot_notifier()       // 初始化KVM框架
 |   ├─ kvm_cache_create_usercopy()      // 初始化KVM框架
 |   ├─ kvm_async_pf_init()              // 初始化KVM框架
 |   ├─ misc_register()                  // 注册字符设备文件/dev/kvm 
 |   ├─ register_syscore_ops()           // 初始化KVM框架
 |   ├─ kvm_init_debug()                 // 创建debug entry
 |   └─ kvm_vfio_ops_init()
 ├─ vmx_setup_l1d_flush()                // 初始化KVM框架
 └─ vmx_check_vmcs12_offsets()
```

# kvm_init: 初始化kvm框架

vmx.c定义了vmx的架构下的操作函数`vmx_x86_ops`, 其他架构也有自己的定义

`vmx_init()`将自己的`vmx_x86_ops`作为参数传了进去

```cpp
r = kvm_init(&vmx_x86_ops, sizeof(struct vcpu_vmx), __alignof__(struct vcpu_vmx), THIS_MODULE);
```

正式进行KVM框架初始化

## 架构初始化

使用传入的`vmx_x86_ops`参数, 注意这是`void *`类型的

```cpp
r = kvm_arch_init(opaque);
```

先功能性检查, 

### 