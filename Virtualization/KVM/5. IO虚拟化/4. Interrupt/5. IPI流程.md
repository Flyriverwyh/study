
对于多核CPU需要IPI机制进行通知或者唤醒，当CPU接收到的中断不是本地中断的时候，需要通过IPI唤醒对端CPU，然后进行中断的传递

那么QEMU中如何实现不同VCPU通知的呢

首先在初始化KVM虚拟机的时候，注册了核间通信处理函数，这个函数完成了IPI的功能




Guest内核发送IPI，也就是向虚拟机APIC的寄存器中写入，对APIC的写动作会被截获，并退出到ROOT模式，对APIC的写动作调用 apic_reg_write()


```cpp
static const struct kvm_io_device_ops apic_mmio_ops = {
.read     = apic_mmio_read,
.write    = apic_mmio_write,
};
```

```cpp
apic_mmio_write -> apic_reg_write
```


apic_reg_write 

-> case APIC_ICR: apic_send_ipi() 

-> 设定目的CPU//irq.dest_id = GET_APIC_DEST_FIELD(icr_high); 

-> kvm_irq_delivery_to_apic //发送到目的VCPU 

-> kvm_apic_set_irq(vcpu, irq, dest_map);
